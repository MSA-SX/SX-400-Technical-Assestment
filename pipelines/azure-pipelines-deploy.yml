
trigger: none #no triggers, depends on the build pipeline

resources:
  pipelines:
    - pipeline: buildPipeline
      source: 'sx400-build'          # ‚Üê Name of your build pipeline in Azure DevOps
      trigger:
        branches:
          include:
            - main

pool:
  name: 'pool'

variables:
  azureSubscription: 'Your Service Connection'  #Service Connection to deploy resources in azure    
  backendAppName: 'BE-AppService'   #Name of your backend appservice
  frontendAppName: 'FE-AppService'   #Name of your frontend appservice

stages:
  - stage: Deploy
    displayName: 'Deploy to App Services'
    jobs:
      # Job 1: Deploy Backend API
      - deployment: DeployBackend
        displayName: 'Deploy Backend API'
        environment: 'production-backend'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: buildPipeline  #Using the BE drop created in the build stage
                  artifact: 'backend-drop'
                  displayName: 'Download backend artifact'

                - task: AzureWebApp@1
                  displayName: 'Deploy to Backend App Service'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: 'webAppLinux'
                    appName: $(backendAppName)
                    package: '$(Pipeline.Workspace)/buildPipeline/backend-drop'
                    runtimeStack: 'DOTNETCORE|8.0'

      # Job 2: Deploy Frontend
      - deployment: DeployFrontend
        displayName: 'Deploy Frontend'
        environment: 'production-frontend'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: buildPipeline  #Using the FE drop created in the build stage
                  artifact: 'frontend-drop'
                  displayName: 'Download frontend artifact'

                - task: AzureWebApp@1
                  displayName: 'Deploy to Frontend App Service'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: 'webAppLinux'
                    appName: $(frontendAppName)
                    package: '$(Pipeline.Workspace)/buildPipeline/frontend-drop'
                    runtimeStack: 'NODE|20-lts'
                    startUpCommand: 'pm2 serve /home/site/wwwroot --no-daemon --spa'
