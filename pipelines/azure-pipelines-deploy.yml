
trigger: none

resources:
  pipelines:
    - pipeline: buildPipeline
      source: 'sx400-build'          # ‚Üê Name of your build pipeline in Azure DevOps
      trigger:
        branches:
          include:
            - main

pool:
  name: 'linux-latest'

variables:
  azureSubscription: 'Infra 04 - SX 400 Test'     
  backendAppName: 'sx-400-be-wa'   
  frontendAppName: 'sx400-fe-wa' 

stages:
  - stage: Deploy
    displayName: 'Deploy to App Services'
    jobs:
      # Job 1: Deploy Backend API
      - deployment: DeployBackend
        displayName: 'Deploy Backend API'
        environment: 'production-backend'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: buildPipeline
                  artifact: 'backend-drop'
                  displayName: 'Download backend artifact'

                - task: AzureWebApp@1
                  displayName: 'Deploy to Backend App Service'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: 'webAppLinux'
                    appName: $(backendAppName)
                    package: '$(Pipeline.Workspace)/buildPipeline/backend-drop'
                    runtimeStack: 'DOTNETCORE|8.0'

      # Job 2: Deploy Frontend
      - deployment: DeployFrontend
        displayName: 'Deploy Frontend'
        environment: 'production-frontend'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: buildPipeline
                  artifact: 'frontend-drop'
                  displayName: 'Download frontend artifact'

                - task: AzureWebApp@1
                  displayName: 'Deploy to Frontend App Service'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    appType: 'webAppLinux'
                    appName: $(frontendAppName)
                    package: '$(Pipeline.Workspace)/buildPipeline/frontend-drop'
                    runtimeStack: 'NODE|20-lts'
                    startUpCommand: 'pm2 serve /home/site/wwwroot --no-daemon --spa'
